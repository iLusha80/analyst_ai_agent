# frontend-streamlit/app.py
import streamlit as st
import pandas as pd
import json

from lc_agent.agent_builder import create_lc_agent

st.set_page_config(page_title="Insight Agent", page_icon="üí°", layout="wide")

# --- –§–£–ù–ö–¶–ò–ò –° –ö–≠–®–ò–†–û–í–ê–ù–ò–ï–ú ---

@st.cache_data
def load_quick_queries(file_path="frontend-streamlit/queries.json"):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ JSON-—Ñ–∞–π–ª–∞."""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError) as e:
        st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏: {e}")
        return []

@st.cache_resource
def load_agent():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä AI-–∞–≥–µ–Ω—Ç–∞."""
    return create_lc_agent()

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SESSION STATE ---

if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø Insight Agent. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –ø–æ –¥–∞–Ω–Ω—ã–º."}
    ]

if "last_processed_message" not in st.session_state:
    st.session_state.last_processed_message = None


# --- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (SIDEBAR) ---

with st.sidebar:
    st.title("üí° Insight Agent")
    st.info("–ü—Ä–æ—Ç–æ—Ç–∏–ø AI-–∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö.")
    st.markdown("---")
    st.markdown("–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É '–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö', —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.")

# --- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–ê ---

st.title("üí¨ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç")

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ session_state
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        if isinstance(message["content"], pd.DataFrame):
            st.dataframe(message["content"])
        else:
            st.markdown(message["content"])

# –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–∞
agent_executor = load_agent()

# --- –ë–õ–û–ö –ë–´–°–¢–†–´–• –ó–ê–ü–†–û–°–û–í (–í–ù–£–¢–†–ò –°–í–û–†–ê–ß–ò–í–ê–ï–ú–û–ì–û st.expander) ---

st.markdown("---")

predefined_queries = load_quick_queries()

if predefined_queries:
    # ### –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ###
    # –í–µ—Å—å –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ø–µ—Ä—å –æ–±–µ—Ä–Ω—É—Ç –≤ st.expander.
    # –û–Ω –±—É–¥–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ—Ä–Ω—É—Ç (expanded=False). 
    # –ú–æ–∂–µ—Ç–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å True, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
    with st.expander("üöÄ –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã", expanded=False):
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫ –±—É–¥–µ—Ç –≤ –æ–¥–Ω–æ–º —Ä—è–¥—É
        COLS_PER_ROW = 3

        # –†–∞–∑–±–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ "—Ä—è–¥—ã"
        for i in range(0, len(predefined_queries), COLS_PER_ROW):
            chunk = predefined_queries[i:i + COLS_PER_ROW]
            cols = st.columns(COLS_PER_ROW)

            for j, query in enumerate(chunk):
                if cols[j].button(query, key=query, use_container_width=True):
                    st.session_state.user_input = query
                    st.rerun()

# --- –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –í–í–û–î–ê –ò –í–´–ó–û–í–ê –ê–ì–ï–ù–¢–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---

chat_prompt = st.chat_input("–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–∫–∞–∂–∏ –ø–µ—Ä–≤—ã—Ö 5 –∫–ª–∏–µ–Ω—Ç–æ–≤")
prompt_to_process = chat_prompt or st.session_state.get("user_input")

if prompt_to_process:
    if "user_input" in st.session_state:
        del st.session_state.user_input

    st.session_state.messages.append({"role": "user", "content": prompt_to_process})
    st.rerun()

last_message = st.session_state.messages[-1]
if last_message["role"] == "user" and st.session_state.get("last_processed_message") != last_message["content"]:
    
    with st.chat_message("assistant"):
        with st.spinner("ü§ñ –î—É–º–∞—é..."):
            try:
                prompt = last_message["content"]
                st.session_state.last_processed_message = prompt
                agent_input = {"input": prompt}
                response_dict = agent_executor.invoke(agent_input)
                
                if 'intermediate_steps' in response_dict and response_dict['intermediate_steps']:
                    for action, result in reversed(response_dict['intermediate_steps']):
                        if action.tool == 'display_table' and isinstance(action.tool_input, dict):
                            tool_input = action.tool_input
                            df = pd.DataFrame(tool_input.get('data', []), columns=tool_input.get('columns', []))
                            st.dataframe(df)
                            st.session_state.messages.append({"role": "assistant", "content": df})
                            break
                
                response_content = response_dict.get('output', '–ù–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.')
                if response_content:
                    st.markdown(response_content)
                    st.session_state.messages.append({"role": "assistant", "content": response_content})

            except Exception as e:
                import traceback
                error_message = traceback.format_exc()
                print(error_message)
                response_content = f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}"
                st.error(response_content)
                st.session_state.messages.append({"role": "assistant", "content": response_content})
    
    st.rerun()

================================================================================

# frontend-streamlit/tools/__init__.py


================================================================================

# frontend-streamlit/tools/custom_tools.py
# frontend-streamlit/tools/custom_tools.py

from sqlalchemy.engine import Engine
from sqlalchemy import text


def get_table_schema_description(engine: Engine) -> str:
    """
    –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏ –∏—Ö –ø–æ–ª–µ–π
    –∏–∑ –Ω–∞—à–µ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã 'table_metadata'.

    –≠—Ç–æ –≥–æ—Ä–∞–∑–¥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–µ–µ –¥–ª—è LLM, —á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥,
    —Ç–∞–∫ –∫–∞–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ.
    """
    try:
        with engine.connect() as connection:
            query = text("SELECT table_name, column_name, description FROM table_metadata ORDER BY table_name, id;")
            results = connection.execute(query).fetchall()

        if not results:
            return "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ 'table_metadata' —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ö–µ–º—ã. –ê–≥–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –±–µ–∑ –Ω–µ–µ."

        schema_description = "–í–æ—Ç —Å—Ö–µ–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:\n\n"
        current_table = ""
        for row in results:
            table, column, description = row
            if table != current_table:
                current_table = table
                schema_description += f"–¢–∞–±–ª–∏—Ü–∞ `{current_table}`:\n"
            schema_description += f"- –ü–æ–ª–µ `{column}`: {description}\n"

        return schema_description

    except Exception as e:
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}"


================================================================================

# frontend-streamlit/core/__init__.py
# frontend-streamlit/core/__init__.py

from .db_connect import get_engine, get_db_uri

# __all__ - —ç—Ç–æ —Å–ø–∏—Å–æ–∫ –∏–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã,
# –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç 'from core import *'. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞.
__all__ = [
    'get_engine',
    'get_db_uri'
]


================================================================================

# frontend-streamlit/core/db_connect.py
# frontend-streamlit/core/db_connect.py

import os
from sqlalchemy import create_engine, Engine
import streamlit as st
from dotenv import load_dotenv


def get_db_uri() -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç URI –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    """
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
    # –ü—É—Ç—å '../../.env' –æ–∑–Ω–∞—á–∞–µ—Ç "–ø–æ–¥–Ω—è—Ç—å—Å—è –Ω–∞ –¥–≤–∞ —É—Ä–æ–≤–Ω—è –≤–≤–µ—Ä—Ö –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞"
    dotenv_path = os.path.join(os.path.dirname(__file__), '..', '..', '.env')
    load_dotenv(dotenv_path=dotenv_path)

    # –ü–æ–ª—É—á–∞–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    user = os.getenv("POSTGRES_USER")
    password = os.getenv("POSTGRES_PASSWORD")
    db = os.getenv("POSTGRES_DB")
    # –•–æ—Å—Ç 'db' - —ç—Ç–æ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤ docker-compose.yml
    # –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–Ω–µ –¥–æ–∫–µ—Ä–∞, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'localhost'
    host = os.getenv("DB_HOST", "localhost")
    # –ü–æ—Ä—Ç 5433 –º—ã –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–ª–∏ –Ω–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—É –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
    # –í–Ω—É—Ç—Ä–∏ Docker-—Å–µ—Ç–∏ —Å–µ—Ä–≤–∏—Å—ã –æ–±—â–∞—é—Ç—Å—è –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –ø–æ—Ä—Ç–∞–º
    port = os.getenv("DB_PORT", "5433")

    if not all([user, password, db, host, port]):
        raise ValueError("–û–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ë–î –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")

    # –§–æ—Ä–º–∞—Ç URI –¥–ª—è SQLAlchemy: postgresql+–¥—Ä–∞–π–≤–µ—Ä://user:password@host:port/dbname
    return f"postgresql+psycopg2://{user}:{password}@{host}:{port}/{db}"


@st.cache_resource
def get_engine() -> Engine:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç –æ–±—ä–µ–∫—Ç SQLAlchemy Engine.

    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @st.cache_resource –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑,
    –∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–±—ä–µ–∫—Ç Engine) –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö
    –∑–∞–ø—É—Å–∫–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ UI).

    Returns:
        sqlalchemy.engine.Engine: –û–±—ä–µ–∫—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î.
    """
    try:
        uri = get_db_uri()
        print("–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (Engine)...")  # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        engine = create_engine(uri)
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        with engine.connect() as connection:
            print("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
        return engine
    except Exception as e:
        st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º None –∏–ª–∏ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–ø–∞–ª–æ
        return None

================================================================================

# frontend-streamlit/pages/data_schema.py
import streamlit as st
import pandas as pd
from sqlalchemy.engine import Engine

from core import get_engine # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

st.set_page_config(page_title="–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö",
                   page_icon="üìÑ",
                   layout="wide")


# –ò—Å–ø–æ–ª—å–∑—É–µ–º @st.cache_data, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
@st.cache_data(ttl=3600)
def load_metadata(_engine: Engine) -> pd.DataFrame:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã table_metadata."""
    if _engine is None:
        return pd.DataFrame()
    try:
        query = "SELECT table_name, column_name, description FROM table_metadata ORDER BY table_name, id;"
        return pd.read_sql(query, _engine)
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: {e}")
        return pd.DataFrame()

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

st.title("üìÑ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö")
st.markdown("""
–ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –ø–æ–ª–µ–π, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
AI-–∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.
""")

# –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
engine = get_engine()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if engine is None:
    st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.")
    st.stop()

metadata_df = load_metadata(engine)

if metadata_df.empty:
    st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü. –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö.")
else:
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    for table_name, group in metadata_df.groupby('table_name'):
        with st.expander(f"–¢–∞–±–ª–∏—Ü–∞: `{table_name}`", expanded=True):
            st.table(group[['column_name', 'description']].rename(columns={
                'column_name': '–ü–æ–ª–µ',
                'description': '–û–ø–∏—Å–∞–Ω–∏–µ'
            }).set_index('–ü–æ–ª–µ'))

================================================================================

# frontend-streamlit/lc_agent/__init__.py


================================================================================

# frontend-streamlit/lc_agent/prompts.py
# frontend-streamlit/lc_agent/prompts.py (–í–ï–†–°–ò–Ø –î–õ–Ø Pydantic-–ò–ù–°–¢–†–£–ú–ï–ù–¢–ê)

LC_AGENT_PROMPT_PREFIX = """
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–º–µ–Ω–∏ Insight Agent.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º—É –Ω–∏–∂–µ —Ä–∞–±–æ—á–µ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É.

**–†–ê–ë–û–ß–ò–ô –ü–†–û–¶–ï–°–°:**

**–®–ê–ì 1: –ò–ó–£–ß–ï–ù–ò–ï –°–•–ï–ú–´ –î–ê–ù–ù–´–• (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)**
- –î–ª—è –õ–Æ–ë–û–ì–û –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–≤–æ–µ **–ø–µ—Ä–≤–æ–µ –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ** ‚Äî —ç—Ç–æ –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ `database_schema_description`.

**–®–ê–ì 2: –°–û–°–¢–ê–í–õ–ï–ù–ò–ï –ò –í–´–ü–û–õ–ù–ï–ù–ò–ï SQL-–ó–ê–ü–†–û–°–ê**
- –ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è —Å—Ö–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `sql_db_query` –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `SELECT` –∑–∞–ø—Ä–æ—Å–∞.

**–®–ê–ì 3: –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –§–ò–ù–ê–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê**
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞.

- **–ï–°–õ–ò –†–ï–ó–£–õ–¨–¢–ê–¢ –°–û–î–ï–†–ñ–ò–¢ –¢–ê–ë–õ–ò–ß–ù–´–ï –î–ê–ù–ù–´–ï:**
  - **–¢–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `display_table`.**
  - –í–æ–∑—å–º–∏ **–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π, –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –æ—Ç `sql_db_query`.
  - –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –µ–≥–æ –≤ JSON-—Å—Ç—Ä–æ–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é –¥–≤–∞ –∫–ª—é—á–∞:
    - `data`: JSON-–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π), –≥–¥–µ –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã, –∞ –∫–ª—é—á–∏ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫.
    - `columns`: JSON-–º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
  - **–ü—Ä–∏–º–µ—Ä JSON-—Ñ–æ—Ä–º–∞—Ç–∞:**
    ```json
    {
      "data": [
        {"–ì–æ—Ä–æ–¥": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤": 40, "–ö–ª–∏–µ–Ω—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–æ–π": 22, "–î–æ–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π (%)": 55.0},
        {"–ì–æ—Ä–æ–¥": "–ö–∞–∑–∞–Ω—å", "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤": 35, "–ö–ª–∏–µ–Ω—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–æ–π": 23, "–î–æ–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π (%)": 65.71}
      ],
      "columns": ["–ì–æ—Ä–æ–¥", "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤", "–ö–ª–∏–µ–Ω—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–æ–π", "–î–æ–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π (%)"]
    }
    ```
  - –ü–µ—Ä–µ–¥–∞–π —ç—Ç—É JSON-—Å—Ç—Ä–æ–∫—É –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä `json_input` –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ `display_table`.
  - –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, —á—Ç–æ —Ç—ã –Ω–∞—à–µ–ª.

- **–ï–°–õ–ò –†–ï–ó–£–õ–¨–¢–ê–¢ ‚Äî –≠–¢–û –û–î–ù–û –ó–ù–ê–ß–ï–ù–ò–ï (–Ω–∞–ø—Ä–∏–º–µ—Ä, `COUNT`):**
  - –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –∏ —è—Å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""

================================================================================

# frontend-streamlit/lc_agent/agent_builder.py
# frontend-streamlit/lc_agent/agent_builder.py (–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–†–ê–í–ò–õ–¨–ù–´–ú –ü–†–ò–ï–ú–û–ú –ê–†–ì–£–ú–ï–ù–¢–û–í)

import json
from langchain_community.agent_toolkits import create_sql_agent, SQLDatabaseToolkit
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain.agents import AgentExecutor
from langchain_community.utilities.sql_database import SQLDatabase
from langchain.tools import Tool
from typing import List
from pydantic.v1 import BaseModel, Field
from langchain_core.tools import BaseTool

from langchain_core.agents import AgentFinish
from langchain_core.exceptions import OutputParserException

from core.db_connect import get_engine
from .prompts import LC_AGENT_PROMPT_PREFIX
from tools.custom_tools import get_table_schema_description

class TableDisplayArgs(BaseModel):
    json_input: str = Field(description="JSON-—Å—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π –∏ —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–ª–æ–Ω–æ–∫.")

class DisplayTableTool(BaseTool):
    """–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É–∂–∏—Ç —Å–∏–≥–Ω–∞–ª–æ–º –¥–ª—è UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã."""
    name: str = "display_table"
    description: str = (
        "–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. "
        "–ü–µ—Ä–µ–¥–∞–π –µ–º—É –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫."
    )
    args_schema: type[BaseModel] = TableDisplayArgs

    # --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    # –ú—ã —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã 'data' –∏ 'columns'.
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç LangChain –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ –Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON.
    def _run(self, json_input: str) -> str:
        # –ü–∞—Ä—Å–∏–º json_input –∫–∞–∫ JSON-—Å—Ç—Ä–æ–∫—É
        try:
            parsed_input = json.loads(json_input)
            data = parsed_input.get("data")
            columns = parsed_input.get("columns")

            if data is None or columns is None:
                return f"–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç 'data' –∏–ª–∏ 'columns' –≤ json_input: {json_input}"

            # –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–∏–∫–∞–∫–æ–π –ª–æ–≥–∏–∫–∏,
            # –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
            return "–¢–∞–±–ª–∏—Ü–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."
        except json.JSONDecodeError as e:
            return f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}. –ü–æ–ª—É—á–µ–Ω–æ: {json_input}"

def _handle_parsing_error(error: OutputParserException) -> AgentFinish:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ LLM."""
    response = error.llm_output
    print(f"–ü–û–ô–ú–ê–ù–ê –û–®–ò–ë–ö–ê –ü–ê–†–°–ò–ù–ì–ê. –í–æ–∑–≤—Ä–∞—â–∞–µ–º '—Å—ã—Ä–æ–π' —Ç–µ–∫—Å—Ç: {response}")
    return AgentFinish({"output": response}, log=str(error))

def create_lc_agent() -> AgentExecutor:
    """–°–æ–∑–¥–∞–µ—Ç LangChain SQL Agent."""
    engine = get_engine()
    db = SQLDatabase(engine)
    llm = ChatGoogleGenerativeAI(model="gemini-2.5-flash-lite", temperature=0)
    
    toolkit = SQLDatabaseToolkit(db=db, llm=llm)

    custom_tools: List[BaseTool] = [
        Tool(
            name="database_schema_description",
            func=lambda _: get_table_schema_description(engine),
            description="–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –í –ü–ï–†–í–£–Æ –û–ß–ï–†–ï–î–¨..."
        ),
        DisplayTableTool()
    ]

    return create_sql_agent(
        llm=llm,
        toolkit=toolkit,
        verbose=True,
        handle_parsing_errors=_handle_parsing_error,
        extra_tools=custom_tools,
        agent_kwargs={"prefix": LC_AGENT_PROMPT_PREFIX}
    )


================================================================================

