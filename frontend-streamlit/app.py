# frontend-streamlit/app.py

import streamlit as st
import pandas as pd
from sqlalchemy.engine import Engine

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–æ–¥—É–ª–∏
from core import init_session_state, get_engine


# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü ---

@st.cache_data(ttl=3600)  # –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ 1 —á–∞—Å
def load_metadata(_engine: Engine) -> pd.DataFrame:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã table_metadata —Å –ø–æ–º–æ—â—å—é pandas.
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @st.cache_data –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î.
    """
    if _engine is None:
        return pd.DataFrame()

    try:
        query = "SELECT table_name, column_name, description FROM table_metadata ORDER BY table_name, id;"
        df = pd.read_sql(query, _engine)
        return df
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: {e}")
        return pd.DataFrame()


def show_data_schema_page(engine: Engine):
    """
    –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É '–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö'.
    """
    st.title("üìÑ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö")
    st.markdown("""
    –ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ –ø–æ–ª–µ–π, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    AI-–∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤.
    """)

    metadata_df = load_metadata(engine)

    if metadata_df.empty:
        st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü. –í–æ–∑–º–æ–∂–Ω–æ, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")
        return

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    for table_name, group in metadata_df.groupby('table_name'):
        with st.expander(f"–¢–∞–±–ª–∏—Ü–∞: `{table_name}`", expanded=True):
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π DataFrame –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ table_name
            st.table(group[['column_name', 'description']].rename(columns={
                'column_name': '–ü–æ–ª–µ',
                'description': '–û–ø–∏—Å–∞–Ω–∏–µ'
            }).set_index('–ü–æ–ª–µ'))


def show_main_chat_page():
    """
    –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —á–∞—Ç–æ–º.
    (–ü–æ–∫–∞ —á—Ç–æ —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, –Ω–æ —É–∂–µ —Å –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏)
    """
    st.title("üí¨ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç")
    st.markdown("–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö.")

    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ st.session_state
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    if prompt := st.chat_input("–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–æ–ª—å–∫–æ —É –Ω–∞—Å –≤—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤?"):
        # –î–æ–±–∞–≤–ª—è–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –≤—ã–∑–æ–≤–∞ AI-–∞–≥–µ–Ω—Ç–∞
        # --- –ù–ê–ß–ê–õ–û –ó–ê–ì–õ–£–®–ö–ò ---
        with st.chat_message("assistant"):
            with st.spinner("–î—É–º–∞—é..."):
                response = "ü§ñ *–≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞.* –ù–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ —è –Ω–∞—É—á—É—Å—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã."
                st.markdown(response)
        st.session_state.messages.append({"role": "assistant", "content": response})
        # --- –ö–û–ù–ï–¶ –ó–ê–ì–õ–£–®–ö–ò ---


# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞—é—â–∞—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    """
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –ø–µ—Ä–≤–æ–π)
    st.set_page_config(
        page_title="Insight Agent",
        page_icon="üí°",
        layout="wide"
    )

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    init_session_state()

    # –ü–æ–ª—É—á–∞–µ–º (–∏–∑ –∫—ç—à–∞) –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    engine = get_engine()

    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞
    with st.sidebar:
        st.title("üí° Insight Agent")

        if engine:
            st.success("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: OK")
        else:
            st.error("‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: –û—à–∏–±–∫–∞")
            st.stop()  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç –ë–î

        # –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        page = st.radio(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É:",
            ["–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç", "–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"],
            label_visibility="collapsed"  # –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É"
        )
        st.markdown("---")
        st.info("–ü—Ä–æ—Ç–æ—Ç–∏–ø AI-–∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –°–æ–∑–¥–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LangChain –∏ Streamlit.")

    # –†–æ—É—Ç–∏–Ω–≥ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    if page == "–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —á–∞—Ç":
        show_main_chat_page()
    elif page == "–û–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö":
        show_data_schema_page(engine)


if __name__ == "__main__":
    main()